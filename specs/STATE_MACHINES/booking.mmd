stateDiagram-v2
    [*] --> Draft: Customer initiates booking
    
    state Draft {
        [*] --> SelectingService: Open booking modal
        SelectingService --> SelectingDateTime: Service selected
        SelectingDateTime --> ReviewingDetails: Time slot selected
        ReviewingDetails --> SelectingDateTime: Change time
        ReviewingDetails --> SelectingService: Change service
        ReviewingDetails --> [*]: Proceed to payment
    }
    
    Draft --> Pending: Payment authorized
    Draft --> Abandoned: Session timeout (30 min)
    
    state Pending {
        [*] --> AwaitingConfirmation
        AwaitingConfirmation --> [*]: Provider confirms
        AwaitingConfirmation --> [*]: Auto-confirm (instant booking)
        AwaitingConfirmation --> [*]: 24hr timeout
    }
    
    Pending --> Confirmed: Provider accepts/Auto-confirm
    Pending --> Cancelled: Customer cancels
    Pending --> Expired: No response (24hr)
    
    state Confirmed {
        [*] --> Upcoming
        Upcoming --> Reminder24Hr: T-24 hours
        Reminder24Hr --> Reminder2Hr: T-2 hours
        Reminder2Hr --> InProgress: Start time reached
        InProgress --> [*]: End time reached
    }
    
    Confirmed --> Completed: Service delivered
    Confirmed --> Cancelled: Cancellation request
    Confirmed --> NoShow: Customer absent
    Confirmed --> Rescheduled: Date/time change
    
    state Cancelled {
        [*] --> ProcessingRefund
        ProcessingRefund --> RefundInitiated: Check policy
        RefundInitiated --> RefundCompleted: Stripe webhook
        RefundCompleted --> [*]
    }
    
    state "Cancellation Guards" as CancelGuards {
        FullRefund: >24hr notice
        PartialRefund: 12-24hr notice  
        NoRefund: <12hr notice
        PlatformRefund: Provider cancels
    }
    
    Cancelled --> CancelGuards: Check timing
    CancelGuards --> Refunded: Process refund
    
    state Completed {
        [*] --> AwaitingReview
        AwaitingReview --> ReviewPrompt24Hr: T+24 hours
        ReviewPrompt24Hr --> ReviewPrompt7Days: T+7 days
        ReviewPrompt7Days --> ReviewExpired: T+30 days
        AwaitingReview --> Reviewed: Review submitted
        ReviewExpired --> [*]
        Reviewed --> [*]
    }
    
    state NoShow {
        [*] --> ProviderReporting
        ProviderReporting --> UnderReview: Report submitted
        UnderReview --> CustomerCharged: Valid no-show
        UnderReview --> ProviderCompensated: Invalid claim
        CustomerCharged --> [*]
        ProviderCompensated --> [*]
    }
    
    state Rescheduled {
        [*] --> FindingNewSlot
        FindingNewSlot --> SlotSelected: Available slot found
        SlotSelected --> BothConfirmed: Both parties agree
        BothConfirmed --> Confirmed: Update booking
        FindingNewSlot --> Cancelled: No agreement
    }
    
    state Disputed {
        [*] --> GatheringInfo
        GatheringInfo --> UnderInvestigation: Info collected
        UnderInvestigation --> Resolution: Decision made
        Resolution --> CustomerFavored: Refund issued
        Resolution --> ProviderFavored: No refund
        CustomerFavored --> Refunded
        ProviderFavored --> Completed
    }
    
    NoShow --> Disputed: Customer disputes
    Completed --> Disputed: Quality dispute
    Cancelled --> Disputed: Refund dispute
    
    Abandoned --> [*]
    Expired --> [*]
    Refunded --> [*]
    
    note right of Draft
        Holds availability for 10 minutes
        Releases on abandon/timeout
    end note
    
    note right of Pending
        Payment pre-authorized only
        Not captured until confirmed
    end note
    
    note right of Confirmed
        Payment captured
        Calendar events created
        SMS reminders scheduled
    end note
    
    note right of Completed
        Triggers payout to provider
        Minus platform commission
        24hr hold for disputes
    end note
    
    note left of Cancelled
        Compensation logic:
        - Customer cancel >24hr: Full refund
        - Customer cancel 12-24hr: 50% refund
        - Customer cancel <12hr: No refund
        - Provider cancel: Full refund + credit
        - Platform cancel: Full refund
    end note
    
    note left of Disputed
        Escalation path:
        1. Automated resolution attempt
        2. Customer service review
        3. Management escalation
        4. Potential platform guarantee
    end note